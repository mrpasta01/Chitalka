package com.example.myapplication;

import static android.content.ContentValues.TAG;

import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.os.Bundle;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.CursorAdapter;
import android.widget.FrameLayout;
import androidx.activity.EdgeToEdge;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.appcompat.app.AppCompatActivity;
import android.Manifest;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.provider.OpenableColumns;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;
import android.database.sqlite.*;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteStatement;
import android.database.sqlite.SQLiteOpenHelper;
import android.database.sqlite.SQLiteCursor;
import android.database.sqlite.SQLiteQueryBuilder;
import android.database.sqlite.SQLiteDatabase.CursorFactory;
import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import androidx.documentfile.provider.DocumentFile;

class DatabaseHelper extends SQLiteOpenHelper {

    private static final String DATABASE_NAME = "LIBRARY";
    private static final String TABLE_NAME = "BOOKS";
    private static final String COL_1 = "ID";
    private static final String COL_2 = "NAME";
    private static final String COL_3 = "WAY";

    public DatabaseHelper(@Nullable Context context) {
        super(context, DATABASE_NAME, null, 1);
    }

    @Override
    public void onCreate(SQLiteDatabase db) {

        db.execSQL("CREATE TABLE IF NOT EXISTS " + TABLE_NAME + "(ID INTEGER PRIMARY KEY AUTOINCREMENT , NAME, WAY)");

    }

    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {

        db.execSQL("DROP TABLE IF EXISTS " + TABLE_NAME);
        onCreate(db);


    }
}
public class MainActivity extends AppCompatActivity {
    private static final int REQUEST_CODE_OPEN_DOCUMENT = 1;
    Button firstBook, MenuTurnOnButton, OutSettingsButton, OutSoderzButton,InSettingsButton, InSoderzButton;
    FrameLayout File, Menu, Settings, Soderz;
    SQLiteDatabase db;
    Log Log = null;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        firstBook = findViewById(R.id.firstBook);
        MenuTurnOnButton = findViewById(R.id.MenuTurnOnButtonBoo);
        File = findViewById(R.id.File);
        Menu = findViewById(R.id.Menu);
        Settings = findViewById(R.id.Settings);
        Soderz = findViewById(R.id.Soderz);
        OutSettingsButton = findViewById(R.id.OutSettingsButton);
        OutSoderzButton = findViewById(R.id.OutSoderzButton);
        InSettingsButton = findViewById(R.id.InSettingsButton);
        InSoderzButton = findViewById(R.id.InSoderzButton);
        Soderz = findViewById(R.id.Soderz);
        openFile();
        db = getBaseContext().openOrCreateDatabase("app.db", MODE_PRIVATE, null);
        db.execSQL("CREATE TABLE IF NOT EXISTS book(Number INTEGER, linkToFileDB TEXT, PositionInBook TEXT)");
    }
    public void openFile() {
        firstBook.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                openFileChooser();
            }
        });
    }
    private void openFileChooser() {
        Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
        intent.addCategory(Intent.CATEGORY_OPENABLE);
        intent.setType("*/*");

        startActivityForResult(intent, REQUEST_CODE_OPEN_DOCUMENT);
    }

    // Обработка результата выбора файла
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        if (requestCode == REQUEST_CODE_OPEN_DOCUMENT && resultCode == RESULT_OK) {
            if (data != null) {
                Uri uri = data.getData();
                String fileType = getContentResolver().getType(uri); // Получаем MIME-тип файла

                // Проверка типа файла
                if (fileType != null &&
                        (fileType.equals("application/pdf") ||  // PDF файл
                                fileType.equals("application/vnd.openxmlformats-officedocument.wordprocessingml.document") ||  // DOCX файл
                                fileType.equals("text/plain") ||  // Текстовые файлы
                                fileType.equals("application/epub+zip") ||  // EPUB файл
                                fileType.equals("application/x-fictionbook+xml"))) {  // FictionBook файл

                    // Здесь вы можете обработать файл, если его тип соответствует одному из указанных
                    Toast.makeText(this, "Файл успешно выбран: " + uri.toString(), Toast.LENGTH_SHORT).show();
                    DocumentFile documentFile = DocumentFile.fromSingleUri(this, uri);
                    String path = getPathFromDocumentUri(documentFile);

                    if (path != null) {
                        Toast.makeText(this, "Путь к файлу: " + path, Toast.LENGTH_SHORT).show();
                        db.execSQL("INSERT OR IGNORE INTO book VALUES ('" + path + "', '0');");
                    } else {
                        Toast.makeText(this, "Не удалось получить путь к файлу.", Toast.LENGTH_SHORT).show();
                    }

                    // Ваш код для обработки файла здесь
                } else {
                    // Обработка случая, когда файл не соответствует ожидаемым типам
                    Toast.makeText(this, "Неподдерживаемый тип файла", Toast.LENGTH_SHORT).show();
                }
            }
        }
    }

    // Метод для получения пути к файлу
    private String getPathFromDocumentUri(DocumentFile documentFile) {
        try {
            return documentFile.getName(); // Возвращает имя файла
        } catch (Exception e) {
            Log.e(TAG, "Ошибка при получении имени файла: ", e);
            return null;
        }
    }
    public void MenuTurnOff(View view){
        File.setEnabled(true);
        Menu.setVisibility(View.INVISIBLE);
        File.setVisibility(View.VISIBLE);
    }
    public void MenuTurnOn(View view){
        File.setEnabled(false); // Делаем FrameLayout неактивным
        Menu.setVisibility(View.VISIBLE);
    }
    public void InSettings(View view){
        Menu.setVisibility(View.INVISIBLE);
        File.setVisibility(View.INVISIBLE);
        Settings.setVisibility(View.VISIBLE);

    }
    public void OutSettings(View view){
        Settings.setVisibility(View.INVISIBLE);
        File.setVisibility(View.VISIBLE);
        Menu.setVisibility(View.VISIBLE);
    }
    public void InSoderz(View view){
        Menu.setVisibility(View.INVISIBLE);
        File.setVisibility(View.INVISIBLE);
        Soderz.setVisibility(View.VISIBLE);
    }
    public void OutSoderz(View view){
        Soderz.setVisibility(View.INVISIBLE);
        File.setVisibility(View.VISIBLE);
        Menu.setVisibility(View.VISIBLE);
    }

}
